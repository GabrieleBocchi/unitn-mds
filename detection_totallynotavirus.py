from math import sqrt

import cv2
import numpy as np
import pywt
from numpy.linalg import norm
from scipy.linalg import svd
from scipy.signal import convolve2d
from skimage.metrics import mean_squared_error
from skimage.metrics import structural_similarity as ssim


def wpsnr(img1, img2):
    img1 = np.float32(img1) / 255.0
    img2 = np.float32(img2) / 255.0
    difference = img1 - img2
    same = not np.any(difference)
    if same is True:
        return 9999999
    w = np.genfromtxt("csf.csv", delimiter=",")
    ew = convolve2d(difference, np.rot90(w, 2), mode="valid")
    decibels = 20.0 * np.log10(1.0 / sqrt(np.mean(np.mean(ew**2))))
    return decibels


# Function to compute the SVD
def compute_svd(matrix):
    U, S, Vt = svd(matrix, full_matrices=False)
    return U, S, Vt


# Function to compare singular values using Frobenius norm
def compare_singular_values(S1, S2):
    return norm(S1 - S2)


# Function to reconstruct the watermark from its SVD components
def reconstruct_from_svd(U, S, Vt):
    return np.dot(U, np.dot(np.diag(S), Vt))


# Function to compare original and candidate watermarks
def compare_watermarks(original, candidate):
    mse_value = mean_squared_error(original, candidate)
    original_resized = cv2.resize(original, (7, 7), interpolation=cv2.INTER_LINEAR)
    candidate_resized = cv2.resize(candidate, (7, 7), interpolation=cv2.INTER_LINEAR)
    ssim_value = ssim(original_resized, candidate_resized, data_range=1)
    return mse_value, ssim_value


def singular_value_similarity(A, B):
    # Compute the SVD
    _, s_B, _ = np.linalg.svd(B, full_matrices=False)

    # Compare the singular values (you can use other distance metrics)
    return np.linalg.norm(A[1] - s_B)


def vector_similarity(A, B):
    from scipy.spatial.distance import cosine

    # Compute the SVD
    U_A, _, V_A = A
    U_B, _, V_B = B

    # Compute cosine similarity between U and V (or pick one of the matrices)
    u_similarity = np.mean(
        [1 - cosine(U_A[:, i], U_B[:, i]) for i in range(U_A.shape[1])]
    )
    v_similarity = np.mean(
        [1 - cosine(V_A[:, i], V_B[:, i]) for i in range(V_A.shape[1])]
    )

    return (u_similarity + v_similarity) / 2


# DETECTION CODE CANNOT FIND THE WATERMARK IN A NON-WATERMARKED IMAGE OR DESTROYED IMAGES (WPSNR<25) (CHECK!)
def detection(input1, input2, input3):
    """
    Check if the watermark is still present or not in the attached image.

    :param input1: Path to the original image.
    :param input2: Path to the watermarked image.
    :param input3: Path to the attacked image.
    :return: Watermark detected (1 or 0) and WPSNR.
    """
    mark_size = 1024
    alpha = 0.3
    v = "additive"
    watermark_svd = (
        np.array(
            [
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
            ],
            dtype=np.float32,
        ),
        np.array([2.275961303710937500e01], dtype=np.float32),
        np.array([[1.0]], dtype=np.float32),
    )

    image = cv2.imread(input1, cv2.IMREAD_GRAYSCALE)
    watermarked_image = cv2.imread(input2, cv2.IMREAD_GRAYSCALE)
    attacked_image = cv2.imread(input3, cv2.IMREAD_GRAYSCALE)

    _, (LH1_image, _, _) = pywt.dwt2(image, "haar")
    LL2_image, (_, _, _) = pywt.dwt2(LH1_image, "haar")
    _, (LH3_image, HL3_image, HH3_image) = pywt.dwt2(LL2_image, "haar")

    # Perform 2D DWT on the watermarked image
    _, (LH1, _, _) = pywt.dwt2(watermarked_image, "haar")
    LL2, (_, _, _) = pywt.dwt2(LH1, "haar")
    _, (LH3, HL3, HH3) = pywt.dwt2(LL2, "haar")

    # Perform 2D DWT on the attacked image
    _, (LH1_att, _, _) = pywt.dwt2(attacked_image, "haar")
    LL2_att, (_, _, _) = pywt.dwt2(LH1_att, "haar")
    _, (LH3_att, HL3_att, HH3_att) = pywt.dwt2(LL2_att, "haar")

    # Define the subbands to process
    subbands = {
        "LH": (LH3, LH3_att, LH3_image),
        "HL": (HL3, HL3_att, HL3_image),
        "HH": (HH3, HH3_att, HH3_image),
    }
    extracted_marks = []
    attacked_marks = []

    # Process each subband
    for _, (band, band_att, band_image) in subbands.items():
        extracted_mark = np.zeros(mark_size)
        attacked_mark = np.zeros(mark_size)
        # Get the locations in the subband
        abs_band = abs(band)
        abs_band_att = abs(band_att)
        locations_band = np.argsort(-abs_band, axis=None)  # Descending order
        rows_band = band.shape[0]
        locations_band = [
            (val // rows_band, val % rows_band) for val in locations_band
        ]  # (x, y) coordinates

        # band_image = np.abs(band_image)

        # Extract the watermark from the sub-band
        for idx, loc in enumerate(
            locations_band[1 : mark_size + 1]
        ):  # Skip the first location
            if idx >= mark_size:
                print(f"IDX {idx} bigger than mark size {mark_size}")
                break
            if v == "additive":
                extracted_mark[idx] = (abs_band[loc] - band_image[loc]) / (alpha)
                attacked_mark[idx] = (abs_band_att[loc] - band_image[loc]) / (alpha)
            elif v == "multiplicative":
                extracted_mark[idx] = (abs_band[loc] - band_image[loc]) / (
                    alpha * band_image[loc]
                )
                attacked_mark[idx] = (abs_band_att[loc] - band_image[loc]) / (
                    alpha * band_image[loc]
                )

        extracted_mark = np.clip(extracted_mark, 0, 1)
        # attacked_mark = np.clip(attacked_mark, 0, 1)
        extracted_marks.append(extracted_mark)
        attacked_marks.append(attacked_mark)

    original_mark = np.mean(extracted_marks, axis=0)

    singular_value_diffs = []
    mse_ssim_scores = []

    best_candidate = None
    highest_sim = -1

    for candidate in attacked_marks:
        candidate_matrix = np.reshape(candidate, (mark_size, 1))
        # Compute SVD for the candidate watermark
        U_cand, S_cand, Vt_cand = compute_svd(candidate_matrix)

        # 1. Singular value comparison
        sv_diff = compare_singular_values(watermark_svd[1], S_cand)
        singular_value_diffs.append(sv_diff)

        # 2. Reconstruct watermarks
        original_reconstructed = reconstruct_from_svd(
            watermark_svd[0], watermark_svd[1], watermark_svd[2]
        )
        candidate_reconstructed = reconstruct_from_svd(U_cand, S_cand, Vt_cand)

        # 3. Compare reconstructed watermarks (MSE and SSIM)
        mse_val, ssim_val = compare_watermarks(
            original_reconstructed, candidate_reconstructed
        )

        sim3 = vector_similarity(watermark_svd, (U_cand, S_cand, Vt_cand))
        mse_ssim_scores.append((mse_val, ssim_val))

        if sim3 > highest_sim:
            highest_sim = sim3
            best_candidate = candidate

    output1 = 0
    if best_candidate is not None and similarity(best_candidate, original_mark) > 0.71:
        output1 = 1
    output2 = wpsnr(attacked_image, watermarked_image)
    return output1, output2


def similarity(X, X_star):
    # Computes the similarity measure between the original and the new watermarks.
    norm_X = np.sqrt(np.sum(np.multiply(X, X)))
    norm_X_star = np.sqrt(np.sum(np.multiply(X_star, X_star)))

    if norm_X == 0 or norm_X_star == 0:
        return 0.0

    s = np.sum(np.multiply(X, X_star)) / (norm_X * norm_X_star)

    return s
