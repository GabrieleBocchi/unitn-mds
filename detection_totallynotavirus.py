from math import sqrt

import cv2
import numpy as np
import pywt
from scipy.linalg import svd
from scipy.signal import convolve2d


def wpsnr(img1, img2):
    img1 = np.float32(img1) / 255.0
    img2 = np.float32(img2) / 255.0
    difference = img1 - img2
    same = not np.any(difference)
    if same is True:
        return 9999999
    w = np.genfromtxt("csf.csv", delimiter=",")
    ew = convolve2d(difference, np.rot90(w, 2), mode="valid")
    decibels = 20.0 * np.log10(1.0 / sqrt(np.mean(np.mean(ew**2))))
    return decibels


# Function to compute the SVD
def compute_svd(matrix):
    U, S, Vt = svd(matrix, full_matrices=False)
    return U, S, Vt


def vector_similarity(A, B):
    from scipy.spatial.distance import cosine

    # Compute the SVD
    U_A, _, V_A = A
    U_B, _, V_B = B

    # Compute cosine similarity between U and V (or pick one of the matrices)
    u_similarity = np.mean(
        [1 - cosine(U_A[:, i], U_B[:, i]) for i in range(U_A.shape[1])]
    )
    v_similarity = np.mean(
        [1 - cosine(V_A[:, i], V_B[:, i]) for i in range(V_A.shape[1])]
    )

    return (u_similarity + v_similarity) / 2


# DETECTION CODE CANNOT FIND THE WATERMARK IN A NON-WATERMARKED IMAGE OR DESTROYED IMAGES (WPSNR<25) (CHECK!)
def detection(input1, input2, input3):
    """
    Check if the watermark is still present or not in the attached image.

    :param input1: Path to the original image.
    :param input2: Path to the watermarked image.
    :param input3: Path to the attacked image.
    :return: Watermark detected (1 or 0) and WPSNR.
    """
    mark_size = 1024
    alpha = 0.3
    v = "additive"
    watermark_svd = (
        np.array(
            [
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
                [4.393747821450233459e-02],
                [4.393747821450233459e-02],
                [0.000000000000000000e00],
                [0.000000000000000000e00],
            ],
            dtype=np.float32,
        ),
        np.array([2.275961303710937500e01], dtype=np.float32),
        np.array([[1.0]], dtype=np.float32),
    )

    image = cv2.imread(input1, cv2.IMREAD_GRAYSCALE)
    watermarked_image = cv2.imread(input2, cv2.IMREAD_GRAYSCALE)
    attacked_image = cv2.imread(input3, cv2.IMREAD_GRAYSCALE)

    _, (LH1_ori, _, _) = pywt.dwt2(image, "haar")
    LL2_ori, (_, _, _) = pywt.dwt2(LH1_ori, "haar")
    _, (LH3_ori, HL3_ori, HH3_ori) = pywt.dwt2(LL2_ori, "haar")

    # Perform 2D DWT on the watermarked image
    _, (LH1_wat, _, _) = pywt.dwt2(watermarked_image, "haar")
    LL2_wat, (_, _, _) = pywt.dwt2(LH1_wat, "haar")
    _, (LH3_wat, HL3_wat, HH3_wat) = pywt.dwt2(LL2_wat, "haar")

    # Perform 2D DWT on the attacked image
    _, (LH1_att, _, _) = pywt.dwt2(attacked_image, "haar")
    LL2_att, (_, _, _) = pywt.dwt2(LH1_att, "haar")
    _, (LH3_att, HL3_att, HH3_att) = pywt.dwt2(LL2_att, "haar")

    # Define the subbands to process
    subbands = [
        (LH3_ori, LH3_wat, LH3_att),
        (HL3_ori, HL3_wat, HL3_att),
        (HH3_ori, HH3_wat, HH3_att),
    ]
    extracted_marks = []
    attacked_marks = []

    # Process each subband
    for band_ori, band_wat, band_att in subbands:
        extracted_mark = np.zeros(mark_size)
        attacked_mark = np.zeros(mark_size)
        # Get the locations in the subband
        abs_band_ori = abs(band_wat)
        abs_band_att = abs(band_att)
        locations_band = np.argsort(-abs_band_ori, axis=None)  # Descending order
        rows_band = band_wat.shape[0]
        locations_band = [
            (val // rows_band, val % rows_band) for val in locations_band
        ]  # (x, y) coordinates

        # Extract the watermark from the sub-band
        for idx, loc in enumerate(
            locations_band[1 : mark_size + 1]
        ):  # Skip the first location
            if idx >= mark_size:
                break
            if v == "additive":
                extracted_mark[idx] = (abs_band_ori[loc] - band_ori[loc]) / (alpha)
                attacked_mark[idx] = (abs_band_att[loc] - band_ori[loc]) / (alpha)
            elif v == "multiplicative":
                extracted_mark[idx] = (abs_band_ori[loc] - band_ori[loc]) / (
                    alpha * band_ori[loc]
                )
                attacked_mark[idx] = (abs_band_att[loc] - band_ori[loc]) / (
                    alpha * band_ori[loc]
                )

        extracted_marks.append(extracted_mark)
        attacked_marks.append(attacked_mark)

    original_mark = np.array(
        [1 if x > 0.5 else 0 for x in np.mean(extracted_marks, axis=0)]
    )
    attacked_marks = [
        [1 if x > 0.5 else 0 for x in att_mark] for att_mark in attacked_marks
    ]

    best_candidate = None
    highest_sim = -1

    for candidate in attacked_marks:
        candidate_matrix = np.reshape(candidate, (mark_size, 1))
        # Compute SVD for the candidate watermark
        U_cand, S_cand, Vt_cand = compute_svd(candidate_matrix)

        sim3 = vector_similarity(watermark_svd, (U_cand, S_cand, Vt_cand))

        if sim3 > highest_sim and sim3 > 0.75:
            highest_sim = sim3
            best_candidate = candidate

    wpsnr_val = wpsnr(attacked_image, watermarked_image)

    if best_candidate is None or wpsnr_val < 25:
        return 0, wpsnr_val

    # if similarity is greater then the threshold, return 1 else 0, wpsnr of the attacked image
    return 1 if similarity(best_candidate, original_mark) > 0.6 else 0, wpsnr_val


def similarity(X, X_star):
    return len([x for x, y in zip(X, X_star) if x == y]) / len(X)
